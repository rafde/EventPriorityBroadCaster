!function(t,n){"use strict";var e="PrioritizedSubPub";"function"==typeof define&&define.amd?define(e,n(t)):"object"==typeof exports?module.exports=n(t):t[e]=n(t)}(this,function(){"use strict";function t(){var t;if(window.console&&console.log){t=p.call(arguments),t.unshift("PSP: ");try{console.log.apply(console,t)}catch(n){console.log(t)}}}function n(t,n,e){return e=e||0,!isNaN(t)&&t>=e&&n>=t}function e(t,n){var e,i=0,s={};for(e=o[i];i<o.length;e=o[++i])s[e]="def"!==e?[]:null;this.subIds={},this.hasPub=!1,this.oldArgs={},this.timings=s,this.eventName=n+t+"-> "}function i(t){this.pspName="",this.events={},this.pspName+="string"==typeof t?t:"PPS"+Math.ceil(1e7*Math.random()),this.pspName+="::"}function s(t){var n=new i(t),e=function(){n.exec.apply(n,p.call(arguments))};return e.pub=function(){return n.pub.apply(n,p.call(arguments)),this},e.sub=function(){return n.sub.apply(n,p.call(arguments)),this},e.unSub=function(){return n.unSub.apply(n,p.call(arguments)),this},e.getEventProxy=function(t){return{pub:function(n){return e.pub(t,n),this},sub:function(n){return e.sub(t,n),this},unSub:function(n){return e.unSub(t,n),this}}},e}function u(t){if("undefined"==typeof this||this===window)r.apply(r,p.call(arguments));else if("string"==typeof t)return new s(t)}var r,o=["pre","def","post"],b=11,p=Array.prototype.slice,h=Array.prototype.indexOf||function(t){var n,e;if(this&&(n=this.length))for(e=0;n>e;e++)if(this[e]===t)return e;return-1};return e.prototype={constructor:e,replaceSubId:function(t){var n,e=this.timings[t.timing];this.removeSubId(t.subId,!1),this.subIds[t.subId]=t,"def"===t.timing?(this.removeSubId(e),this.timings[t.timing]=t.subId):(n=e[t.priority],"undefined"==typeof n&&(n=e[t.priority]=[]),n.push(t.subId))},removeSubId:function(n,e){var i,s,u,r;return"string"==typeof n&&(i=this.subIds[n])&&"object"==typeof i&&(r=this.timings[i.timing],"string"==typeof r?(t(this.eventName+"removing default timing"),this.timings[i.timing]=null):r&&r.length&&(u=r[i.priority])&&u.length&&(s=h.call(u,n))>=0&&u.splice(s,1),("undefined"==typeof e||e===!0)&&delete this.subIds[n]),!1},publishToSubscriber:function(n,e){var i,s,u;return e=e||this.oldArgs,"string"==typeof n&&(i=this.subIds[n])&&"function"==typeof i.sub?(s="number"==typeof i.unPubCount,(!s||s&&i.unPubCount>0)&&(u=i.sub.call(i.context,e)),(u===!1||u!==!0&&s&&--i.unPubCount<=0)&&(t(this.eventName+"Subscriber subId "+n+" removed itself. Result:",u),this.removeSubId(n)),u):null},publish:function(n){var e,i,s,u,r,b,p,h=0;for(this.oldArgs=n,this.hasPub=!0,e=o[h];h<o.length;e=o[++h])if(s=this.timings[e],"def"===e&&"string"==typeof s)t(this.eventName+"Publishing to default"),this.publishToSubscriber(s,n);else if(s&&s.length)for(i=s.length-1,u=s[i];i>=0;u=s[--i])if(u&&u.length)for(r=0;b=u[r];)switch(t(this.eventName+"Publishing subId "+b+" TIMING "+e+" PRIORITY "+i),p=this.publishToSubscriber(b,n)){case!1:break;default:r++}}},i.prototype={constructor:i,pub:function(t,n){var e=this.getEvent(t);e&&e.publish(n)},sub:function(e,i){var s,u,r=typeof i,p="function"===r;return i&&("object"===r||p)?(p&&(i={sub:i}),s=this.getEvent(e),"string"!=typeof i.subId&&(i.subId="pr-"+Math.ceil(1e7*Math.random())),u=parseInt(i.priority,10),i.priority=n(u,b)?u:Math.round(b/2),u=h.call(o,i.timing),i.timing=0>u?o[0]:o[u],s.replaceSubId(i),i.rePub&&s.hasPub&&(t(this.pspName+e+" event was published. Re-publish subId "+i.subId),s.publishToSubscriber(i.subId)),!0):(t(this.pspName+e+" was not given a legitimate config"),null)},unSub:function(n,e){var i=this.getEvent(n);i&&(t(this.pspName+"un-subscribing subId "+e+" from EVENT "+n),i.removeSubId(e))},getEvent:function(n){var i=this.events[n];return i||(t(this.pspName+"Creating new subscription for EVENT "+n),this.events[n]=i=new e(n,this.pspName)),i},exec:function(n,e){var i,s;e=e||{},e&&"string"==typeof n&&(s="object"==(i=typeof e),"function"===i||s&&"function"==typeof e.sub?null===this.sub(n,e)&&t(this.pspName+"Subscription definition was invalid and was not registered"):s&&("string"==typeof e.unSub?this.unSub(n,e.unSub):(e=e.pub||e,this.pub(n,e))))}},r=new s("GLOBAL"),u.sub=r.sub,u.pub=r.pub,u.unSub=r.unSub,u.getEventProxy=r.getEventProxy,u});